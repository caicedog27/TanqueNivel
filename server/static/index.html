<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Control de Niveles</title>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #0d1117;
      color: #e6e6e6;
      font-family: Arial, Helvetica, sans-serif;
    }
    header {
      padding: 16px;
      background-color: #161b22;
      text-align: center;
      font-size: 1.6rem;
      color: #58a6ff;
      border-bottom: 1px solid #30363d;
    }
    .container {
      display: flex;
      flex-wrap: wrap;
      padding: 16px;
      gap: 16px;
    }
    .card {
      background-color: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 16px;
      flex: 1 1 300px;
      min-width: 280px;
    }
    .status {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 12px;
    }
    .status .indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
    }
    .status .name {
      flex: 1;
    }
    .controls label {
      display: block;
      margin: 8px 0 4px;
    }
    .controls input[type="number"],
    .controls input[type="range"],
    .controls select {
      width: 100%;
      padding: 6px;
      border-radius: 4px;
      border: 1px solid #30363d;
      background-color: #0d1117;
      color: #e6e6e6;
    }
    .controls button {
      margin-top: 8px;
      padding: 8px;
      width: 100%;
      border: none;
      border-radius: 4px;
      background-color: #238636;
      color: white;
      cursor: pointer;
    }
    .controls button.secondary {
      background-color: #da3633;
    }
    .charts {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
    }
    .chart-container {
      flex: 1 1 400px;
      min-width: 300px;
      background-color: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 16px;
    }
    #toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
    }
    .toast {
      background-color: #21262d;
      border-left: 4px solid #58a6ff;
      padding: 8px 12px;
      margin-bottom: 8px;
      color: #e6e6e6;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      opacity: 0.9;
      animation: fadeInOut 4s linear forwards;
    }
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateX(20px); }
      10% { opacity: 0.9; transform: translateX(0); }
      90% { opacity: 0.9; }
      100% { opacity: 0; }
    }
  </style>
</head>
<body>
  <header>Sistema de Control de Niveles</header>
  <div class="container">
    <!-- Status and Controls Card -->
    <div class="card">
      <h2>Estado del Sistema</h2>
      <div class="status" id="statusSens">
        <span class="indicator" style="background-color: grey;"></span>
        <span class="name">Sensores</span>
        <span class="state"></span>
      </div>
      <div class="status" id="statusAct">
        <span class="indicator" style="background-color: grey;"></span>
        <span class="name">Actuador</span>
        <span class="state"></span>
      </div>
      <div class="status" id="statusMaster">
        <span class="indicator" style="background-color: grey;"></span>
        <span class="name">Maestro</span>
        <span class="state"></span>
      </div>
      <div class="status" id="statusPump">
        <span class="indicator" style="background-color: grey;"></span>
        <span class="name">Bomba</span>
        <span class="state"></span>
      </div>
      <div class="status" id="statusDistTanque">
        <span class="indicator" style="width:0;height:0;"></span>
        <span class="name">Distancia Tanque</span>
        <span class="state"></span>
      </div>
      <div class="status" id="statusDistTolva">
        <span class="indicator" style="width:0;height:0;"></span>
        <span class="name">Distancia Tolva</span>
        <span class="state"></span>
      </div>
      <h2>Controles</h2>
      <div class="controls">
        <label for="modeSelect">Modo:</label>
        <select id="modeSelect">
          <option value="AUTO">Automático</option>
          <option value="MANUAL">Manual</option>
        </select>
        <button id="pumpOnBtn" disabled>Encender Bomba</button>
        <button id="pumpOffBtn" class="secondary" disabled>Apagar Bomba</button>
        <label for="spInput">Setpoint Tolva (%)</label>
        <input type="number" id="spInput" min="0" max="100" step="0.5" value="60">
        <label for="hysteresisInput">Histéresis (%)</label>
        <input type="number" id="hysteresisInput" min="0" max="20" step="0.5" value="5">
        <button id="saveConfigBtn">Guardar Config</button>
        <label for="pulseSlider">Frecuencia de pulsos (pulsos/min)</label>
        <input type="range" id="pulseSlider" min="0.02" max="3" step="0.02" value="1">
        <span id="pulseValue">1.00</span>
        <hr style="margin:12px 0;border-color:#30363d;">
        <h3>Calibración de Sensores</h3>
        <label for="emptyTanqueInput">Distancia vacía Tanque (mm)</label>
        <input type="number" id="emptyTanqueInput" min="0" max="5000" step="1" value="1200">
        <label for="fullTanqueInput">Distancia llena Tanque (mm)</label>
        <input type="number" id="fullTanqueInput" min="0" max="5000" step="1" value="200">
        <label for="emptyTolvaInput">Distancia vacía Tolva (mm)</label>
        <input type="number" id="emptyTolvaInput" min="0" max="5000" step="1" value="800">
        <label for="fullTolvaInput">Distancia llena Tolva (mm)</label>
        <input type="number" id="fullTolvaInput" min="0" max="5000" step="1" value="100">
        <button id="saveCalibrationBtn">Guardar Calibración</button>
      </div>
    </div>
    <!-- Charts Card -->
    <div class="card" style="flex: 2 1 600px;">
      <h2>Gráficos de Niveles</h2>
      <div class="charts">
        <div class="chart-container">
          <canvas id="tankChart"></canvas>
        </div>
        <div class="chart-container">
          <canvas id="tolvaChart"></canvas>
        </div>
      </div>
    </div>
  </div>
  <div id="toast-container"></div>
  <script>
    // Data arrays for charts
    const tankData = [];
    const tolvaData = [];
    const maxPoints = 50; // maximum points on chart
    // Initialize charts
    const tankCtx = document.getElementById('tankChart').getContext('2d');
    const tolvaCtx = document.getElementById('tolvaChart').getContext('2d');
    const tankChart = new Chart(tankCtx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Nivel Tanque (%)',
          data: [],
          borderColor: '#58a6ff',
          backgroundColor: 'rgba(88,166,255,0.3)',
          tension: 0.3,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            ticks: { color: '#e6e6e6' }
          },
          y: {
            beginAtZero: true,
            max: 100,
            ticks: { color: '#e6e6e6' }
          }
        },
        plugins: {
          legend: { labels: { color: '#e6e6e6' } }
        }
      }
    });
    const tolvaChart = new Chart(tolvaCtx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Nivel Tolva (%)',
          data: [],
          borderColor: '#dba617',
          backgroundColor: 'rgba(219,166,23,0.3)',
          tension: 0.3,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            ticks: { color: '#e6e6e6' }
          },
          y: {
            beginAtZero: true,
            max: 100,
            ticks: { color: '#e6e6e6' }
          }
        },
        plugins: {
          legend: { labels: { color: '#e6e6e6' } }
        }
      }
    });
    // Toast function
    function showToast(msg) {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = msg;
      container.appendChild(toast);
      setTimeout(() => {
        container.removeChild(toast);
      }, 4000);
    }
    // Update status UI
    function updateStatus(id, online, extra) {
      const el = document.getElementById(id);
      const indicator = el.querySelector('.indicator');
      const state = el.querySelector('.state');
      if (online) {
        indicator.style.backgroundColor = '#2ea043';
        state.textContent = extra || 'Online';
      } else {
        indicator.style.backgroundColor = '#da3633';
        state.textContent = extra || 'Offline';
      }
    }
    // UI elements
    const modeSelect = document.getElementById('modeSelect');
    const pumpOnBtn = document.getElementById('pumpOnBtn');
    const pumpOffBtn = document.getElementById('pumpOffBtn');
    const spInput = document.getElementById('spInput');
    const hysteresisInput = document.getElementById('hysteresisInput');
    const saveConfigBtn = document.getElementById('saveConfigBtn');
    const emptyTanqueInput = document.getElementById('emptyTanqueInput');
    const fullTanqueInput = document.getElementById('fullTanqueInput');
    const emptyTolvaInput = document.getElementById('emptyTolvaInput');
    const fullTolvaInput = document.getElementById('fullTolvaInput');
    const saveCalibrationBtn = document.getElementById('saveCalibrationBtn');
    const pulseSlider = document.getElementById('pulseSlider');
    const pulseValue = document.getElementById('pulseValue');

    // Update pulse value label
    function setPulseLabel(value) {
      pulseValue.textContent = parseFloat(value).toFixed(2);
    }
    setPulseLabel(pulseSlider.value);
    pulseSlider.addEventListener('input', (e) => {
      setPulseLabel(e.target.value);
    });
    pulseSlider.addEventListener('change', (e) => {
      const rate = parseFloat(e.target.value);
      fetch('/pulse', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ pulse_rate: rate })
      }).catch(err => console.error(err));
    });
    // Event listeners
    modeSelect.addEventListener('change', () => {
      fetch('/mode', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ mode: modeSelect.value })
      }).catch(err => console.error(err));
    });
    pumpOnBtn.addEventListener('click', () => {
      fetch('/command', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ cmd: 'PUMP_ON' })
      }).catch(err => console.error(err));
    });
    pumpOffBtn.addEventListener('click', () => {
      fetch('/command', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ cmd: 'PUMP_OFF' })
      }).catch(err => console.error(err));
    });
    saveConfigBtn.addEventListener('click', () => {
      const sp = parseFloat(spInput.value);
      const hyster = parseFloat(hysteresisInput.value);
      const payload = { SP_tolva: sp, hysteresis: hyster };
      fetch('/config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }).catch(err => console.error(err));
    });

    // Save calibration values for sensors
    saveCalibrationBtn.addEventListener('click', () => {
      const emptyTanque = parseFloat(emptyTanqueInput.value);
      const fullTanque = parseFloat(fullTanqueInput.value);
      const emptyTolva  = parseFloat(emptyTolvaInput.value);
      const fullTolva  = parseFloat(fullTolvaInput.value);
      const payload = {
        empty_tanque_mm: emptyTanque,
        full_tanque_mm: fullTanque,
        empty_tolva_mm: emptyTolva,
        full_tolva_mm: fullTolva
      };
      fetch('/config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }).then(() => {
        showToast('Calibración guardada');
      }).catch(err => console.error(err));
    });
    // Track previous state for notifications
    let prevBoards = { SENS: false, ACT: false, MASTER: false };
    let prevPumpState = null;
    // WebSocket connection
    const ws = new WebSocket(`ws://${location.host}/ws/client`);
    ws.onopen = () => {
      showToast('Conectado al servidor');
    };
    ws.onclose = () => {
      showToast('Desconectado del servidor');
    };
    ws.onmessage = (ev) => {
      const msg = JSON.parse(ev.data);
      if (msg.type === 'state') {
        const s = msg.state;
        const boards = s.boards;
        const config = msg.config;
        // Update mode select
        modeSelect.value = config.mode;
        // Enable/disable pump buttons based on mode
        const manual = config.mode === 'MANUAL';
        pumpOnBtn.disabled = !manual;
        pumpOffBtn.disabled = !manual;
        // Update SP and hysteresis inputs
        spInput.value = config.SP_tolva;
        hysteresisInput.value = config.hysteresis;
        // Update pulse slider
        if (config.pulse_rate !== undefined) {
          pulseSlider.value = config.pulse_rate;
          setPulseLabel(config.pulse_rate);
        }
        // Update calibration inputs
        if (config.empty_tanque_mm !== undefined) emptyTanqueInput.value = config.empty_tanque_mm;
        if (config.full_tanque_mm !== undefined)  fullTanqueInput.value  = config.full_tanque_mm;
        if (config.empty_tolva_mm !== undefined) emptyTolvaInput.value  = config.empty_tolva_mm;
        if (config.full_tolva_mm !== undefined)  fullTolvaInput.value   = config.full_tolva_mm;
        // Update board statuses and show notifications if changed
        ['SENS', 'ACT', 'MASTER'].forEach(key => {
          const online = boards[key].online;
          updateStatus('status' + key.charAt(0) + key.slice(1).toUpperCase(), online);
          if (prevBoards[key] !== undefined && prevBoards[key] !== online) {
            showToast(`${key} ${online ? 'conectado' : 'desconectado'}`);
          }
          prevBoards[key] = online;
        });
        // Update pump status
        const pumpOn = s.pump_state === true;
        updateStatus('statusPump', pumpOn, pumpOn ? 'Encendida' : 'Apagada');
        if (prevPumpState !== null && prevPumpState !== pumpOn) {
          showToast(`Bomba ${pumpOn ? 'encendida' : 'apagada'}`);
        }
        prevPumpState = pumpOn;
        // Add new points to charts if levels available
        const now = new Date();
        const ts = now.toLocaleTimeString();
        if (s.tanque_pct !== null && !isNaN(s.tanque_pct)) {
          tankChart.data.labels.push(ts);
          tankChart.data.datasets[0].data.push(s.tanque_pct);
          if (tankChart.data.labels.length > maxPoints) {
            tankChart.data.labels.shift();
            tankChart.data.datasets[0].data.shift();
          }
          tankChart.update('none');
        }
        if (s.tolva_pct !== null && !isNaN(s.tolva_pct)) {
          tolvaChart.data.labels.push(ts);
          tolvaChart.data.datasets[0].data.push(s.tolva_pct);
          if (tolvaChart.data.labels.length > maxPoints) {
            tolvaChart.data.labels.shift();
            tolvaChart.data.datasets[0].data.shift();
          }
          tolvaChart.update('none');
        }

        // Update raw distances display
        const distTankSpan = document.getElementById('statusDistTanque').querySelector('.state');
        const distTolvaSpan= document.getElementById('statusDistTolva').querySelector('.state');
        if (s.tanque_mm !== undefined && s.tanque_mm !== null) {
          distTankSpan.textContent = `${s.tanque_mm} mm`;
        }
        if (s.tolva_mm !== undefined && s.tolva_mm !== null) {
          distTolvaSpan.textContent = `${s.tolva_mm} mm`;
        }
      }
    };
  </script>
</body>
</html>